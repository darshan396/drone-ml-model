<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover Mission Control</title>
    <style>
        /* --- CORE VISUALS --- */
        :root { 
            --bg: #000000; 
            --card: #111111; 
            --border: #333333; 
            --text: #ffffff; 
            --text-dim: #888888; 
            --danger: #ff4444; 
            --success: #00cc66; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 40px; 
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        .header { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center; }
        .header-title h1 { margin: 0; font-size: 2.5rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        
        /* STATUS BADGE */
        .status-badge { display: flex; align-items: center; padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; font-weight: 700; font-size: 0.9rem; transition: 0.3s; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .status-online { color: var(--success); border-color: var(--success); }
        .status-online .status-dot { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-offline { color: var(--danger); border-color: var(--danger); }
        .status-offline .status-dot { background: var(--danger); }

        /* UPLOAD ZONE */
        .upload-box { 
            border: 1px dashed var(--border); 
            background: var(--card); 
            border-radius: 8px; 
            padding: 80px; 
            text-align: center; 
            cursor: pointer; 
            transition: 0.2s;
            margin-bottom: 20px;
        }
        .upload-box:hover { border-color: white; background: #1a1a1a; }
        
        /* MAIN BUTTON */
        .btn { 
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: 6px; 
            font-size: 1rem; 
            font-weight: 700; 
            cursor: pointer; 
            background: white; 
            color: black; 
            text-transform: uppercase; 
        }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* STATS GRID */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .card { background: var(--card); padding: 25px; border-radius: 8px; border: 1px solid var(--border); }
        .card h3 { color: var(--text-dim); font-size: 0.7rem; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 1.8rem; font-weight: 700; }

        /* TABLE */
        h2 { font-size: 1.2rem; margin-top: 40px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text-dim); padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        
        img.preview { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #333; cursor: zoom-in; transition: 0.2s; }
        img.preview:hover { transform: scale(1.1); border-color: white; }

        /* ICON BUTTON STYLE */
        .icon-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }
        .icon-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .icon-btn:hover { border-color: var(--danger); background: rgba(255, 68, 68, 0.1); color: var(--danger); }

        /* MODAL */
        #modal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; }
        #modalImg { max-width: 90%; max-height: 80vh; border-radius: 4px; border: 1px solid #444; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>Surface Analysis Dashboard</h1>
                <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">AI-Powered Hazard Detection System</div>
            </div>
            <div id="statusBadge" class="status-badge status-offline">
                <span class="status-dot"></span><span id="statusText">OFFLINE</span>
            </div>
        </div>

        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 2rem; margin-bottom: 10px;">â†‘</div>
            <p style="color: #888; margin: 0;">Drag & drop multiple images here or click to upload.</p>
            <div id="fileName" style="color: white; margin-top: 15px; font-weight: bold;"></div>
            <input type="file" id="fileInput" hidden multiple onchange="handleFileSelect(this.files)">
        </div>

        <button id="analyzeBtn" class="btn" onclick="processQueue()" disabled>Waiting for Server...</button>

        <div class="stats">
            <div class="card"><h3>Total Analyzed</h3><div class="value" id="totalCount">0</div></div>
            <div class="card"><h3>Avg. Safety</h3><div class="value" id="avgSafety">--%</div></div>
            <div class="card"><h3>Latency</h3><div class="value" id="latencyVal">--ms</div></div>
        </div>

        <h2>Mission Logs</h2>
        <table>
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Timestamp</th>
                    <th>Filename</th>
                    <th>Safety Score</th>
                    <th>Result</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="modal" onclick="this.style.display='none'">
        <img id="modalImg">
        <div style="color: #666; position: absolute; bottom: 50px; font-size: 0.8rem; text-transform: uppercase;">Click to Close</div>
    </div>

    <script>
        const API_URL = "http://localhost:8000"; 
        let selectedFiles = []; // Changed to array
        let isBackendOnline = false;

        // --- HEARTBEAT ---
        async function checkServerStatus() {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            const start = Date.now();
            try {
                const res = await fetch(`${API_URL}/history`);
                if (res.ok) {
                    if (!isBackendOnline) {
                        isBackendOnline = true;
                        badge.className = "status-badge status-online";
                        text.innerText = "SYSTEM ACTIVE";
                        if(selectedFiles.length > 0) {
                            document.getElementById('analyzeBtn').disabled = false;
                            document.getElementById('analyzeBtn').innerText = `Run Terrain Analysis (${selectedFiles.length})`;
                        } else {
                            document.getElementById('analyzeBtn').innerText = "Run Terrain Analysis";
                        }
                        loadHistory();
                    }
                    document.getElementById('latencyVal').innerText = (Date.now() - start) + "ms";
                }
            } catch (e) {
                isBackendOnline = false;
                badge.className = "status-badge status-offline";
                text.innerText = "OFFLINE";
                document.getElementById('analyzeBtn').disabled = true;
            }
        }
        setInterval(checkServerStatus, 2000);
        checkServerStatus();

        function handleFileSelect(files) {
            if (files.length > 0) {
                selectedFiles = Array.from(files); // Convert FileList to Array
                document.getElementById('fileName').innerText = `SELECTED: ${selectedFiles.length} Images`;
                
                if(isBackendOnline) {
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('analyzeBtn').innerText = `Run Terrain Analysis (${selectedFiles.length})`;
                }
            }
        }

        // --- NEW BATCH PROCESS FUNCTION ---
        async function processQueue() {
            if (selectedFiles.length === 0 || !isBackendOnline) return;
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;

            // Loop through all selected files
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                btn.innerText = `Processing ${i + 1}/${selectedFiles.length}...`;
                
                const formData = new FormData();
                formData.append("file", file);

                try {
                    await fetch(`${API_URL}/analyze`, { method: 'POST', body: formData });
                } catch (e) { 
                    console.error("Upload failed for " + file.name); 
                }
            }
            
            loadHistory(); 
            btn.innerText = "Analysis Complete";
            selectedFiles = []; // Clear queue
            document.getElementById('fileName').innerText = "";
            
            setTimeout(() => { 
                btn.disabled = false; 
                btn.innerText = "Run Terrain Analysis"; 
            }, 1500);
        }

        // --- DELETE FUNCTION ---
        async function deleteLog(id) {
            if(!confirm("Are you sure you want to delete this log?")) return;
            try {
                const res = await fetch(`${API_URL}/history/${id}`, { method: 'DELETE' });
                if(res.ok) loadHistory();
                else alert("Failed to delete.");
            } catch(e) { console.error(e); }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API_URL}/history`);
                const data = await res.json();
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";
                
                let totalScore = 0;
                data.sort((a,b) => b.id - a.id);

                data.forEach(row => {
                    totalScore += parseFloat(row.score);
                    const imgUrl = `${API_URL}/uploads/${row.filename}`;
                    const color = row.status === "SAFE" ? "#00cc66" : "#ff4444";
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><img src="${imgUrl}" class="preview" onclick="openModal('${imgUrl}')"></td>
                        <td style="color:#666; font-family:monospace;">${row.date}</td>
                        <td style="color:#888;">${row.filename}</td>
                        <td style="font-weight:bold;">${row.score}%</td>
                        <td style="color:${color}; font-weight:bold;">${row.status}</td>
                        <td>
                            <button class="icon-btn" onclick="deleteLog(${row.id})" title="Delete Log">
                                <svg viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Update Stats
                document.getElementById('totalCount').innerText = data.length;
                if (data.length > 0) {
                    document.getElementById('avgSafety').innerText = Math.round(totalScore / data.length) + "%";
                } else {
                    document.getElementById('avgSafety').innerText = "--%";
                }
            } catch (e) { console.log("History sync skipped"); }
        }

        function openModal(img) {
            document.getElementById('modalImg').src = img;
            document.getElementById('modal').style.display = "flex";
        }
    </script>
</body>
</html>